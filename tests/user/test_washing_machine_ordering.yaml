testcase:
  name: washing_machine_ordering
  description: 下单
  allure:
    epic: C端
    feature: 下单流程
    story: xxx下单

  steps:
    - id: slot_get
      description: 广告位配置查询
      project:
      path: /slot/get
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        slotKey: banner_01
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success
        - type: equal
          field: data.slotKey
          expected: "banner_01"

    - id: position_nearPosition
      description: 附近点位
      project:
      path: /position/nearPosition
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        lng: 120.1421
        lat: 30.31974
        page: 1
        pageSize: 10
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: trade_underway_stateList
      description: 最新订单状态列表
      project:
      path: /trade/underway/stateList
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: position_positionDevice
      description: 店铺设备情况
      project:
      path: /position/positionDevice
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        id: '{{position_nearPosition.data.items[0].id}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: goods_scan
      description: 扫码
      project: user
      path: '/goods/scan'
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        n: 3d6adba1-dbae-4218-9e43-73a8ec54ab56
      assert:
        - type: equal
          field: code
          expected: 0
        - type: is not None
          field: data.goodsId
        - type: equal
          field: message
          expected: success

    - id: appointment_goodsExist
      description: 判别是否已预约
      project:
      path: /appointment/goodsExist
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        goodsId: '{{goods_scan.data.goodsId}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: goods_normal_details
      description: 商品详情
      project:
      path: /goods/normal/details
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        goodsId: '{{goods_scan.data.goodsId}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: goods_normal_items
      description: 商品item列表
      project:
      path: /goods/normal/items
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        goodsId: '{{goods_scan.data.goodsId}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success
        - type: is not None
          field: data

    - id: notice_getNoticeByShopId
      description: 获取店铺当前配置的公告
      project:
      path: /notice/getNoticeByShopId
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        applicationId: 2
        displayLocation: 2
        shopId: '{{goods_scan.data.shopId}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: goods_stateList
      description: 商品状态列表
      project:
      path: /goods/stateList
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        goodsId: '{{goods_scan.data.goodsId}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: activity_queryAndExecute
      description: 查询活动匹配并执行
      project:
      path: /activity/queryAndExecute
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        activityExecuteNodeId: 100
        hashKey: '{{goods_scan.data.activityHashKey}}'
        orderNo: ''
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: trade_scanOrderCreate
      description: 扫码下单
      project:
      path: /trade/scanOrderCreate
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        purchaseList:
          - goodsId: '{{goods_scan.data.goodsId}}'
            goodsItemId: '{{goods_normal_items.data[1].id}}'
            soldType: 1
            amount: 1
            num: 1
        hashKey: '{{goods_scan.data.activityHashKey}}'
        reserveMethod: null
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success
        - type: is not None
          field: data.orderNo

    - id: trade_detail
      description: 订单详情
      project:
      path: /trade/detail
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: pay_checkstand
      description: 收银台
      project:
      path: /pay/checkstand
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: trade_underway_preview
      description: 进行中订单预览
      project:
      path: /trade/underway/preview/V2
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        autoSelectPromotion: true
        promotionList: []
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: activity_queryAndExecute_pre_pay
      description: 查询活动匹配并执行(支付前)
      project:
      path: /activity/queryAndExecute
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
        hashKey: '{{goods_scan.data.activityHashKey}}'
        activityExecuteNodeId: 200
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: shopConfig_list
      description: 店铺设置列表
      project:
      path: /shopConfig/list
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        goodsCategoryId: '{{goods_normal_details.data.categoryId}}'
        shopId: '{{goods_scan.data.shopId}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: balance_unWithdraw_info
      description: 余额信息
      project:
      path: /balance/unWithdraw/info
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: goods_verify
      description: 下单前验证设备
      project:
      path: /goods/verify
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        categoryCode: '{{goods_scan.data.categoryCode}}'
        goodsId: '{{goods_scan.data.goodsId}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success
        - type: equal
          field: data.isSuccess
          expected: true

    - id: trade_underway_create
      description: 进行中订单下单
      project:
      path: /trade/underway/create
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        autoSelectPromotion: false
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
        promotionList: []
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: pay_prePay
      description: 预支付
      project:
      path: /pay/prePay
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
        payMethod: 1001
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success
        - type: is not None
          field: data.prepayParam

    - id: pay_pay
      description: 支付
      project:
      path: /pay/pay
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        prepayParam: '{{pay_prePay.data.prepayParam}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success
        - type: equal
          field: data.success
          expected: true

    - id: trade_detail_after_pay
      description: 订单详情
      project:
      path: /trade/detail
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: feedback_getFeedbackOrderReplayTotal
      description: 获取未查看回复列表
      project:
      path: /feedback/getFeedbackOrderReplayTotal
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data: {}
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: trade_list
      description: 订单列表
      project:
      path: /trade/list
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        page: 1
        pageSize: 10
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: account_getWechatPublicAccountSubscribeFlag
      description: 获取公众号是否被关注
      project:
      path: /account/getWechatPublicAccountSubscribeFlag
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: trade_detail_after_pay_01
      description: 订单详情
      project:
      path: /trade/detail
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success
        - type: equal
          field: data.orderNo
          expected: '{{trade_scanOrderCreate.data.orderNo}}'

    - id: trade_allowFeedbackCount
      description: 获取待评价订单数量
      project:
      path: /trade/allowFeedbackCount
      method: GET
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: slot_get_after_pay
      description: 广告位配置查询
      project:
      path: /slot/get
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
        shopId: '{{goods_scan.data.shopId}}'
        slotKey: running_ele_ad_weixin
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: activity_queryAndExecute_after_pay
      description: 查询活动匹配并执行(支付后)
      project:
      path: /activity/queryAndExecute
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{ user.token }}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
        activityExecuteNodeId: 300
        hashKey: ''
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

  teardowns:
    - id: order_refund
      description: 退款
      operation_type: api
      project: merchant
      path: /order/refund
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{merchant.token}}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
        refundPrice: '{{trade_detail_after_pay.data.realPrice}}'
        refundMethod: 1
        reason: '测试'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success

    - id: trade_finishByOrder
      description: 结束订单
      operation_type: api
      project: user
      path: /trade/finishByOrder
      method: POST
      headers:
        Content-Type: 'application/json'
        Authorization: '{{user.token}}'
      data:
        orderNo: '{{trade_scanOrderCreate.data.orderNo}}'
      assert:
        - type: equal
          field: code
          expected: 0
        - type: equal
          field: message
          expected: success